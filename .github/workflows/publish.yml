name: Publish to GitHub Packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.0)'
        required: true
        default: '0.1.0'

permissions:
  contents: write
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          java-version: '25'
          distribution: 'temurin'
          server-id: github
          settings-path: ${{ github.workspace }}

      - name: Verify version matches input
        run: |
          POM_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "Parent POM version: $POM_VERSION"
          echo "Input version: ${{ github.event.inputs.version }}"
          if [ "$POM_VERSION" != "${{ github.event.inputs.version }}" ]; then
            echo "Error: Parent POM version does not match input version"
            exit 1
          fi
          if [[ "$POM_VERSION" == *SNAPSHOT ]]; then
            echo "SNAPSHOT versions are not allowed"
            exit 1
          fi

      - name: Build and test all modules
        run: mvn -B clean verify

      - name: Publish SDK module to GitHub Packages
        run: mvn -B deploy -DskipTests -s ${{ github.workspace }}/settings.xml -pl sdk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: Release v${{ github.event.inputs.version }}
          body: |
            Release ${{ github.event.inputs.version }} of claude-agent-sdk-java

            ## Installation

            ### Maven
            ```xml
            <dependency>
                <groupId>in.vidyalai</groupId>
                <artifactId>claude-agent-sdk-java</artifactId>
                <version>${{ github.event.inputs.version }}</version>
            </dependency>
            ```

            Add GitHub Packages repository and authentication to your `pom.xml` or `~/.m2/settings.xml` - see README for details.

            ## Examples

            Example code is available in the `examples/` module. See the README for instructions on running examples.
          draft: false
          prerelease: false
